---
title: "Johns Hopkins Hospital Influenza Virus Sequencing Frequency Report"
author: Elgin Akin
date: now
execute: 
  echo: false
  message: false
  warning: false
format: 
  html:
    page-layout: full
    code-fold: true
    embed-resources: true
    toc: true
---

WARNING: **IV25Run16** Not shown in plots below due to ambiguous date
WARNING: Omar was kind enough to sequence NH2024-25 genomes in IV25Run17. As of Dec 18, 2025, we have not parsed out which sequences are summer vs fall in origin.

```{r}
#| echo: false
#| output: false 

library(tidyverse)
library(RColorBrewer)
library(plotly)

data <- read_tsv("../reports/report.tsv")
#data <- read_tsv("reports/report.tsv")

data_filtered <- data %>% 
  dplyr::filter(
    subtype %in% c("H1N1", "H3N2", "Victoria"), 
    date >= as.Date("2023-01-01") & date <= as.Date("2025-12-31")
  ) %>%
  dplyr::mutate(date_run = paste(date, sequencing_run, sep = " | ")) 

# Ensure date_run is ordered chronologically
data_filtered <- data_filtered %>%
  mutate(date = as.Date(date)) %>%  # Ensure the date is in Date format
  arrange(date) %>%  # Sort data by date
  mutate(date_run = factor(date_run, levels = unique(date_run)))  # Create factor with ordered levels

```

## Subtype plot
```{r}
#| echo: FALSE
#| output: FALSE 
#| column: screen-inset-shaded 

# Define Dark2 palette for the subtypes
dark2_colors <- brewer.pal(n = 3, name = "Dark2")

# Plot stacked bar chart (showing each date-run pair separately)
subtype_frequency = ggplot(data_filtered, aes(x = factor(date_run, levels = unique(date_run)), fill = subtype)) +
  geom_bar(position = "stack") +
  scale_fill_manual(values = dark2_colors) +  # Apply Dark2 palette
  labs(title = "Johns Hopkins Hospital System - Subtype Frequency",
       x = "Sequence Date | Sequencing Run #",
       y = "Number of Sequences",
       fill = "Subtype") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))  +
  geom_text(stat = "count", aes(label = after_stat(count)), position = position_stack(vjust = 0.5))

```

```{r}
#| echo: FALSE
#| column: screen-inset-shaded 
ggplotly(subtype_frequency)
#ggsave(filename = paste0("../figures/subtype_frequency.png"), plot = subtype_frequency, width = 10, height = 4)
```

```{r}

#| eval: false
#| echo: false
#| output: false 
library(tidyverse)

# Clade and Subclade Frequency (depreciated)
# Define the clade and subclade color palettes
clade_colors <- c(
  # H1N1
  "6B.1A.5a.2a" = "#a0240e", 
  "6B.1A.5a.2a.1" = "#6265cd", 
  # H3N2
  "3C.2a1b.2a.2a.1b" = "#A4BED5FF",
  "3C.2a1b.2a.2a.3a.1" = "#CC4C24FF", 
  "3C.2a1b.2a.2b" = "#32373AFF", 
  # IBV
  "V1A" = "#FF4500", 
  "V1A.3a.2" = "#00CED1"
)

subclade_colors <- c(
  # H1N1
  "C.1" = "#9A133DFF", 
  "C.1.1" = "#B93961FF", 
  "C.1.7" = "#D8527CFF", 
  "C.1.7.2" = "#F28AAAFF", 
  "C.1.8" = "#F9B4C9FF", 
  "C.1.9" = "#F9E0E8FF", 
  "D" = "#1A318BFF", 
  "D.1" = "#4060C8FF", 
  "D.2" = "#6996E3FF", 
  "D.3" = "#A1C2EDFF", 
  "D.4" = "#C5DAF6FF",
  # IBV
  "A" = "#FF6347", 
  "C.3" = "#00CED1", 
  "C.5" = "#9400D3", 
  "C.5.1" = "#FF1493", 
  "C.5.5" = "#FF8C00", 
  "C.5.6" = "#B0E0E6", 
  "C.5.7" = "#808000", 
  # H3N2
  "G.1.1.2" = "#00496FFF", 
  "G.2" = "#0F85A0FF", 
  "J" = "#EDD746FF", 
  "J.1" = "#ED8B00FF", 
  "J.2" = "#DD4124FF"
)

# Define flu season start date
flu_season_start <- as.Date("2024-10-01")

# Function to generate plots for a given subtype
generate_plots <- function(df, subtype_name) {
  df_filtered <- df %>%
    filter(
      subtype == subtype_name,
      date >= as.Date("2023-01-01") & date <= as.Date("2025-12-31"),
      !is.na(clade) & clade != "",
      !is.na(subclade) & subclade != ""
    ) %>%
    mutate(date_run = paste(date, sequencing_run, sep = " | ")) %>%  # Create a unique date-run label
    arrange(date) %>%  # Ensure data is sorted by date
    mutate(date_run = factor(date_run, levels = unique(date_run)))  # Set factor levels in time order

  # Clade Frequency Plot
  clade_plot <- ggplot(df_filtered, aes(x = date_run, fill = clade)) +
    geom_bar(position = "stack") +
    scale_fill_manual(values = clade_colors) +  # Apply clade color palette
    labs(title = paste(subtype_name, "Clade Frequency"),
         x = "Date | Sequencing Run",
         y = "Frequency",
         fill = "Clade") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) +
    geom_vline(xintercept = which(levels(df_filtered$date_run) == as.character(flu_season_start)), 
               linetype = "dotted", color = "red", size = 1) +
    geom_text(stat = "count", aes(label = ..count..), position = position_stack(vjust = 0.5))

  # Subclade Frequency Plot
  subclade_plot <- ggplot(df_filtered, aes(x = date_run, fill = subclade)) +
    geom_bar(position = "stack") +
    scale_fill_manual(values = subclade_colors) +  # Apply subclade color palette
    labs(title = paste(subtype_name, "Subclade Frequency"),
         x = "Date | Sequencing Run",
         y = "Frequency",
         fill = "Subclade") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) +
    geom_vline(xintercept = which(levels(df_filtered$date_run) == as.character(flu_season_start)), 
               linetype = "dotted", color = "red", size = 1) +
    geom_text(stat = "count", aes(label = ..count..), position = position_stack(vjust = 0.5))

  #ggsave(filename = paste0("../figures/", subtype_name, "_clade_plot.png"), plot = clade_plot, width = 10, height = 4)
  #ggsave(filename = paste0("../figures/", subtype_name, "_subclade_plot.png"), plot = subclade_plot, width = 10, height = 4)

  return(list(clade_plot = clade_plot, subclade_plot = subclade_plot))
}

# Generate plots for each subtype
h3n2_plots <- generate_plots(data, "H3N2")
h1n1_plots <- generate_plots(data, "H1N1")
victoria_plots <- generate_plots(data, "Victoria")
```


## Type and Subtype Frequency 


```{r}
#| echo: FALSE

library(tidyverse)
library(DT)
library(knitr)
library(kableExtra)

create_phl_summary_table <- function(df) {
  
  # Calculate current flu season start (October 1st of current or previous year)
  current_date <- Sys.Date()
  current_year <- year(current_date)
  
  # If we're before October, use previous year's October
  if (month(current_date) < 10) {
    flu_season_start <- as.Date(paste0(current_year - 1, "-10-01"))
  } else {
    flu_season_start <- as.Date(paste0(current_year, "-10-01"))
  }
  
  # Filter data for lab sequences since flu season start
  df_filtered <- df %>%
    filter(
      date >= flu_season_start,
      database_origin == "mostafa_lab"
    )
  
  # Get latest sequencing run info
  latest_run_info <- df_filtered %>%
    filter(!is.na(sequencing_run)) %>%
    arrange(desc(date)) %>%
    slice(1) %>%
    select(sequencing_run, date)
  
  latest_run <- latest_run_info$sequencing_run
  latest_run_date <- latest_run_info$date
  
  current_week_data <- df_filtered %>%
    filter(sequencing_run == latest_run)
  
  # Calculate summary statistics
  create_summary <- function(data, period_name) {
    total_specimens <- nrow(data)
    
    # Influenza A breakdown
    flu_a_total <- sum(data$type == "InfluenzaA", na.rm = TRUE)
    flu_a_pct <- ifelse(total_specimens > 0, round(flu_a_total/total_specimens*100, 1), 0)
    
    # Subtyping performed (complete subtypes)
    subtyping_performed <- sum(data$type == "InfluenzaA" & 
                              data$subtype %in% c("H1N1", "H3N2"), na.rm = TRUE)
    subtyping_pct <- ifelse(flu_a_total > 0, round(subtyping_performed/flu_a_total*100, 1), 0)
    
    # H1N1 and H3N2 counts
    h1n1_count <- sum(data$subtype == "H1N1", na.rm = TRUE)
    h1n1_pct <- ifelse(subtyping_performed > 0, round(h1n1_count/subtyping_performed*100, 1), 0)
    
    h3n2_count <- sum(data$subtype == "H3N2", na.rm = TRUE)
    h3n2_pct <- ifelse(subtyping_performed > 0, round(h3n2_count/subtyping_performed*100, 1), 0)
    
    # Subtyping not performed
    subtyping_not_performed <- flu_a_total - subtyping_performed
    subtyping_not_pct <- ifelse(flu_a_total > 0, round(subtyping_not_performed/flu_a_total*100, 1), 0)
    
    # Influenza B
    flu_b_total <- sum(data$type == "InfluenzaB", na.rm = TRUE)
    flu_b_pct <- ifelse(total_specimens > 0, round(flu_b_total/total_specimens*100, 1), 0)
    
    # Lineage testing performed
    lineage_performed <- sum(data$type == "InfluenzaB" & 
                            data$subtype == "Victoria", na.rm = TRUE)
    lineage_performed_pct <- ifelse(flu_b_total > 0, round(lineage_performed/flu_b_total*100, 1), 0)
    
    # Victoria lineage
    victoria_count <- sum(data$subtype == "Victoria", na.rm = TRUE)
    victoria_pct <- ifelse(lineage_performed > 0, round(victoria_count/lineage_performed*100, 1), 0)
    
    # Lineage not performed
    lineage_not_performed <- flu_b_total - lineage_performed
    lineage_not_pct <- ifelse(flu_b_total > 0, round(lineage_not_performed/flu_b_total*100, 1), 0)
    
    return(data.frame(
      period = period_name,
      total_specimens = format(total_specimens, big.mark = ","),
      flu_a = paste0(format(flu_a_total, big.mark = ","), " (", flu_a_pct, "%)"),
      subtyping_performed = paste0(format(subtyping_performed, big.mark = ","), " (", subtyping_pct, "%)"),
      h1n1 = paste0(format(h1n1_count, big.mark = ","), " (", h1n1_pct, "%)"),
      h3n2 = paste0(format(h3n2_count, big.mark = ","), " (", h3n2_pct, "%)"),
      subtyping_not_performed = paste0(format(subtyping_not_performed, big.mark = ","), " (", subtyping_not_pct, "%)"),
      flu_b = paste0(format(flu_b_total, big.mark = ","), " (", flu_b_pct, "%)"),
      lineage_performed = paste0(format(lineage_performed, big.mark = ","), " (", lineage_performed_pct, "%)"),
      yamagata = "0",
      victoria = paste0(format(victoria_count, big.mark = ","), " (", victoria_pct, "%)"),
      lineage_not_performed = paste0(format(lineage_not_performed, big.mark = ","), " (", lineage_not_pct, "%)")
    ))
  }
  
  # Create summaries for current period and cumulative
  current_summary <- create_summary(current_week_data, "Current")
  cumulative_summary <- create_summary(df_filtered, "Cumulative")
  
  # Create the display table
  summary_table <- data.frame(
    Metric = c(
      "Total unique specimen sequences",
      "",
      "Sequences by type/subtype",
      "  Influenza A",
      "",
      "Subtyping Performed",
      "    (H1N1)pdm09",
      "    H3N2", 
      "",
      "Subtyping not performed",
      "",
      "  Influenza B",
      "",
      "Lineage testing performed",
      "    Yamagata lineage",
      "    Victoria lineage",
      "",
      "Lineage not performed"
    ),
    Latest_Run = c(
      current_summary$total_specimens,
      "",
      "",
      current_summary$flu_a,
      "",
      current_summary$subtyping_performed,
      current_summary$h1n1,
      current_summary$h3n2,
      "",
      current_summary$subtyping_not_performed,
      "",
      current_summary$flu_b,
      "",
      current_summary$lineage_performed,
      current_summary$yamagata,
      current_summary$victoria,
      "",
      current_summary$lineage_not_performed
    ),
    Cumulative = c(
      cumulative_summary$total_specimens,
      "",
      "",
      cumulative_summary$flu_a,
      "",
      cumulative_summary$subtyping_performed,
      cumulative_summary$h1n1,
      cumulative_summary$h3n2,
      "",
      cumulative_summary$subtyping_not_performed,
      "",
      cumulative_summary$flu_b,
      "",
      cumulative_summary$lineage_performed,
      cumulative_summary$yamagata,
      cumulative_summary$victoria,
      "",
      cumulative_summary$lineage_not_performed
    )
  )
  
  # Create formatted table
  kable(summary_table, 
        col.names = c("", 
                     paste0(latest_run, " (", format(latest_run_date, "%m/%d/%Y"), ")"),
                     paste("Cumulative since", format(flu_season_start, "%B %d, %Y"))),
        align = c("l", "r", "r"),
        caption = "Johns Hopkins Hospital System - Influenza Surveillance Summary") %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                  full_width = FALSE) %>%
    row_spec(c(3, 5, 10, 12, 14, 17), background = "#f0f0f0", bold = TRUE) %>%
    add_indent(c(4, 6, 7, 8, 10, 12, 14, 15, 16, 18))
  
}

# Generate the summary table
phl_summary <- create_phl_summary_table(data)
phl_summary
```

```{r}
#| echo: FALSE

library(tidyverse)
library(knitr)
library(kableExtra)

create_genetic_characterization_table <- function(df, cumulative_since_october = TRUE) {
  
  # Calculate flu season start if needed
  if (cumulative_since_october) {
    current_date <- Sys.Date()
    current_year <- year(current_date)
    
    if (month(current_date) < 10) {
      flu_season_start <- as.Date(paste0(current_year - 1, "-10-01"))
      flu_season_end <- as.Date(paste0(current_year, "-09-30"))
      season_name <- paste0(current_year - 1, "-", current_year)
    } else {
      flu_season_start <- as.Date(paste0(current_year, "-10-01"))
      flu_season_end <- as.Date(paste0(current_year + 1, "-09-30"))
      season_name <- paste0(current_year, "-", current_year + 1)
    }
    
    df_filtered <- df %>%
      filter(
        date >= flu_season_start,
        database_origin == "mostafa_lab"
      )
  } else {
    df_filtered <- df %>%
      filter(database_origin == "mostafa_lab")
    
    # For all-time data, get actual date range
    date_range <- df_filtered %>%
      summarise(
        min_date = min(date, na.rm = TRUE),
        max_date = max(date, na.rm = TRUE)
      )
    season_name <- paste(format(date_range$min_date, "%B %d, %Y"), 
                        "to", format(date_range$max_date, "%B %d, %Y"))
  }
  
  # Process data for genetic characterization
  genetic_data <- df_filtered %>%
    filter(
      !is.na(subclade), 
      subclade != "",
      subtype %in% c("H1N1", "H3N2", "Victoria")
    ) %>%
    mutate(
      virus_subtype = case_when(
        subtype == "H1N1" ~ "A/H1",
        subtype == "H3N2" ~ "A/H3", 
        subtype == "Victoria" ~ "B/Victoria"
      )
    )
  
  # Create summary by virus subtype and subclade
  subclade_summary <- genetic_data %>%
    group_by(virus_subtype, subclade) %>%
    summarise(subclade_count = n(), .groups = "drop")
  
  # Calculate totals by virus subtype
  subtype_totals <- genetic_data %>%
    group_by(virus_subtype) %>%
    summarise(total_tested = n(), .groups = "drop")
  
  # Merge and calculate percentages
  genetic_summary <- subclade_summary %>%
    left_join(subtype_totals, by = "virus_subtype") %>%
    mutate(
      subclade_pct = round((subclade_count / total_tested) * 100, 1),
      subclade_display = paste0(subclade_count, " (", subclade_pct, "%)")
    ) %>%
    arrange(virus_subtype, desc(subclade_count))
  
  # Create the display table structure
  create_table_rows <- function(subtype_data, subtype_name, total) {
    rows <- list()
    
    # First row with subtype name and total
    rows[[1]] <- data.frame(
      Virus = subtype_name,
      Total = format(total, big.mark = ","),
      HA_Clade = "",
      Clade_Count = "",
      HA_Subclade = "",
      Subclade_Count = "",
      stringsAsFactors = FALSE
    )
    
    # Subsequent rows with subclade data
    for (i in 1:nrow(subtype_data)) {
      rows[[i + 1]] <- data.frame(
        Virus = "",
        Total = "",
        HA_Clade = "",
        Clade_Count = "",
        HA_Subclade = subtype_data$subclade[i],
        Subclade_Count = subtype_data$subclade_display[i],
        stringsAsFactors = FALSE
      )
    }
    
    return(do.call(rbind, rows))
  }
  
  # Process each virus subtype
  all_rows <- list()
  
  # A/H1
  if ("A/H1" %in% genetic_summary$virus_subtype) {
    h1_data <- genetic_summary %>% filter(virus_subtype == "A/H1")
    h1_total <- subtype_totals %>% filter(virus_subtype == "A/H1") %>% pull(total_tested)
    all_rows[["h1"]] <- create_table_rows(h1_data, "A/H1", h1_total)
  }
  
  # A/H3
  if ("A/H3" %in% genetic_summary$virus_subtype) {
    h3_data <- genetic_summary %>% filter(virus_subtype == "A/H3")
    h3_total <- subtype_totals %>% filter(virus_subtype == "A/H3") %>% pull(total_tested)
    all_rows[["h3"]] <- create_table_rows(h3_data, "A/H3", h3_total)
  }
  
  # B/Victoria
  if ("B/Victoria" %in% genetic_summary$virus_subtype) {
    vic_data <- genetic_summary %>% filter(virus_subtype == "B/Victoria")
    vic_total <- subtype_totals %>% filter(virus_subtype == "B/Victoria") %>% pull(total_tested)
    all_rows[["victoria"]] <- create_table_rows(vic_data, "B/Victoria", vic_total)
  }
  
  # Add B/Yamagata row (always 0)
  all_rows[["yamagata"]] <- data.frame(
    Virus = "B/Yamagata",
    Total = "0",
    HA_Clade = "",
    Clade_Count = "",
    HA_Subclade = "",
    Subclade_Count = "",
    stringsAsFactors = FALSE
  )
  
  # Combine all rows
  final_table <- do.call(rbind, all_rows)
  rownames(final_table) <- NULL
  
  # Create the formatted table with season info in title
  if (cumulative_since_october) {
    table_title <- paste("Genetic Characterization - Flu Season", season_name, 
                        "(", format(flu_season_start, "%B %d, %Y"), "to present)")
  } else {
    table_title <- paste("Genetic Characterization -", season_name)
  }
  
  kable(final_table,
        col.names = c(
          "Virus Subtype or Lineage",
          "Total No. of Subtype/Lineage Tested", 
          "HA Clade",
          "Number (% of subtype/lineage tested)",
          "HA Subclade", 
          "Number (% of subtype/lineage tested)"
        ),
        align = c("c", "c", "c", "c", "c", "c"),  # Center all columns
        caption = table_title) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                  full_width = FALSE) %>%
    # Highlight virus subtype rows
    row_spec(which(final_table$Total != ""), background = "#f0f0f0", bold = TRUE) %>%
    # Add column spanning header
    add_header_above(c(" " = 2, "Genetic Characterization" = 4)) %>%
    # Merge cells for virus subtypes with centered alignment
    collapse_rows(columns = 1:2, valign = "middle")
  
}

# Generate the genetic characterization table
genetic_table <- create_genetic_characterization_table(data)
genetic_table
```

# Clade and Subclade Frequency 

```{r}
#| echo: FALSE
library(RColorBrewer)
library(viridis)

### Begin generating color palettes 

generate_palette <- function(n, palette) {
  max_colors <- brewer.pal.info[palette, "maxcolors"]
  base_colors <- brewer.pal(min(n, max_colors), palette)
  if (n <= max_colors) {
    return(base_colors)
  } else {
    return(colorRampPalette(base_colors)(n))
  }
}

# High-contrast palettes - these work well with white text
clade_palette_map <- list(
  "H1N1"    = "viridis",      # 17 colors needed - viridis scales well
  "H3N2"    = "plasma",       # 12 colors needed - plasma has good contrast  
  "Victoria"= "Set1"          # 11 colors needed - Set1 is high contrast
)

subclade_palette_map <- list(
  "H1N1"    = "turbo",        # 17+ colors - turbo is very high contrast
  "H3N2"    = "Set3",         # 12+ colors - Set3 works well with white text
  "Victoria"= "Dark2"         # 11+ colors - Dark2 extended
)

# Enhanced palette generation with better contrast
generate_palette <- function(n, palette) {
  if (palette %in% c("viridis", "plasma", "inferno", "turbo", "cividis")) {
    # Use viridis family - excellent for many colors
    viridis_option <- switch(palette,
                            "viridis" = "D",
                            "plasma" = "C", 
                            "inferno" = "B",
                            "turbo" = "H",
                            "cividis" = "E")
    return(viridis(n, option = viridis_option))
  } else {
    # Use RColorBrewer with extension
    max_colors <- brewer.pal.info[palette, "maxcolors"]
    base_colors <- brewer.pal(min(n, max_colors), palette)
    if (n <= max_colors) {
      return(base_colors)
    } else {
      return(colorRampPalette(base_colors)(n))
    }
  }
}

# Generate clade colors for a given subtype
get_clade_colors <- function(df, subtype) {
  palette <- clade_palette_map[[subtype]]
  
  clades <- df %>%
    filter(subtype == !!subtype, !is.na(clade), clade != "") %>%
    pull(clade) %>% unique() %>% sort()
  
  colors <- generate_palette(length(clades), palette)
  names(colors) <- clades
  colors
}

# Generate subclade colors for a given subtype
get_subclade_colors <- function(df, subtype) {
  palette <- subclade_palette_map[[subtype]]
  
  subclades <- df %>%
    filter(subtype == !!subtype, !is.na(subclade), subclade != "") %>%
    pull(subclade) %>% unique() %>% sort()
  
  colors <- generate_palette(length(subclades), palette)
  names(colors) <- subclades
  colors
}

### Begin generating plots 
generate_plots <- function(df, subtype_name) {
  
  df_filtered <- df %>%
    filter(
      subtype == subtype_name,
      date >= as.Date("2023-01-01") & date <= as.Date("2025-12-31"),
      !is.na(clade), clade != "",
      !is.na(subclade), subclade != ""
    ) %>%
    mutate(date_run = paste(date, sequencing_run, sep = " | ")) %>%
    arrange(date) %>%
    mutate(date_run = factor(date_run, levels = unique(date_run)))

  # *** NEW: subtype-specific palettes ***
  clade_colors    <- get_clade_colors(df_filtered, subtype_name)
  subclade_colors <- get_subclade_colors(df_filtered, subtype_name)

  # Clade Frequency Plot
  clade_plot <- ggplot(df_filtered, aes(x = date_run, fill = clade)) +
    geom_bar(position = "stack") +
    geom_text(stat = "count", 
              aes(label = after_stat(count)), 
              position = position_stack(vjust = 0.5), 
              color = "black", 
              fontface = "bold", 
              size = 3) +
    scale_fill_manual(values = clade_colors) +
    labs(title = paste(subtype_name, "Clade Frequency"),
         x = "Date | Sequencing Run",
         y = "Frequency",
         fill = "Clade") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

  # Subclade Frequency Plot
  subclade_plot <- ggplot(df_filtered, aes(x = date_run, fill = subclade)) +
    geom_bar(position = "stack") +
    geom_text(stat = "count", 
              aes(label = after_stat(count)), 
              position = position_stack(vjust = 0.5), 
              color = "black", 
              fontface = "bold", 
              size = 3) +
    scale_fill_manual(values = subclade_colors) +
    labs(title = paste(subtype_name, "Subclade Frequency"),
         x = "Date | Sequencing Run",
         y = "Frequency",
         fill = "Subclade") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

  return(list(clade_plot = clade_plot, subclade_plot = subclade_plot))
}

# Generate plots for each subtype
h3n2_plots <- generate_plots(data, "H3N2")
h1n1_plots <- generate_plots(data, "H1N1")
victoria_plots <- generate_plots(data, "Victoria")
```

## H3N2
```{r}
#| column: screen-inset-shaded
#ggplotly(h3n2_plots$clade_plot)
ggplotly(h3n2_plots$subclade_plot)
```

## H1N1
```{r}
#| column: screen-inset-shaded
#ggplotly(h1n1_plots$clade_plot)
ggplotly(h1n1_plots$subclade_plot)
```

## B/Victoria
```{r}
#| column: screen-inset-shaded
#ggplotly(victoria_plots$clade_plot)
ggplotly(victoria_plots$subclade_plot)
```

# Interactive Tables

## Total Clade and Subclade Summary by Subtype

```{r}
library(tidyverse)
library(DT)

clade_subclade_summary <- data %>%
  filter(subtype %in% c("H1N1", "H3N2", "Victoria")) %>%
  group_by(subtype) %>%
  summarise(
    total_samples = n(),
    unique_clades = n_distinct(clade[!is.na(clade) & clade != ""]),
    unique_subclades = n_distinct(subclade[!is.na(subclade) & subclade != ""]),
    samples_with_clade = sum(!is.na(clade) & clade != ""),
    samples_with_subclade = sum(!is.na(subclade) & subclade != ""),
    clade_coverage = round((samples_with_clade / total_samples) * 100, 1),
    subclade_coverage = round((samples_with_subclade / total_samples) * 100, 1),
    .groups = 'drop'
  )

datatable(
  clade_subclade_summary,
  caption = "Clade and Subclade Summary by Subtype",
  extensions = 'Buttons',
  options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'print'),
    scrollX = TRUE
  )) %>%
  formatStyle(columns = c('clade_coverage', 'subclade_coverage'), 
              backgroundColor = styleInterval(c(50, 80), c('lightcoral', 'lightyellow', 'lightgreen')))
```

## Seasonal Clade and Subclade Summary (October-September Seasons)

```{r}
# Table 2: Seasonal summary (Oct-Sep seasons)
seasonal_summary <- data %>%
  filter(
    subtype %in% c("H1N1", "H3N2", "Victoria"),
    !is.na(date)
  ) %>%
  mutate(
    # Create flu season (Oct-Sep)
    flu_season = case_when(
      month(date) >= 10 ~ paste0(year(date), "-", year(date) + 1),
      month(date) < 10 ~ paste0(year(date) - 1, "-", year(date)),
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(flu_season)) %>%
  group_by(flu_season, subtype) %>%
  summarise(
    total_samples = n(),
    unique_clades = n_distinct(clade[!is.na(clade) & clade != ""]),
    unique_subclades = n_distinct(subclade[!is.na(subclade) & subclade != ""]),
    samples_with_clade = sum(!is.na(clade) & clade != ""),
    samples_with_subclade = sum(!is.na(subclade) & subclade != ""),
    clade_coverage = round((samples_with_clade / total_samples) * 100, 1),
    subclade_coverage = round((samples_with_subclade / total_samples) * 100, 1),
    .groups = 'drop'
  ) %>%
  arrange(flu_season, subtype)

datatable(
  seasonal_summary,
  caption = "Seasonal Clade and Subclade Summary (October-September Seasons)",
  extensions = 'Buttons',
  filter = list(position = 'top', clear = FALSE),
  options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'print'),
    scrollX = TRUE,
    pageLength = 15
  )
) %>%
  formatStyle(columns = c('clade_coverage', 'subclade_coverage'), 
              backgroundColor = styleInterval(c(50, 80), c('lightcoral', 'lightyellow', 'lightgreen')))
```

## Genome Completeness 
```{r}
genome_completeness_summary <- data %>%
  mutate(
    # Create a more informative subtype category
    subtype_category = case_when(
      subtype %in% c("H1N1", "H3N2", "Victoria") ~ subtype,
      type == "InfluenzaA" & !subtype %in% c("H1N1", "H3N2") ~ paste0("InfluenzaA_", subtype),
      type == "InfluenzaB" & subtype != "Victoria" ~ paste0("InfluenzaB_", subtype),
      is.na(subtype) | subtype == "" ~ paste0(type, "_unknown"),
      TRUE ~ paste0(type, "_", subtype)
    ),
    # Subtyping completeness
    complete_subtype = case_when(
      type == "InfluenzaA" & subtype %in% c("H1N1", "H3N2") ~ "Complete",
      type == "InfluenzaB" & subtype == "Victoria" ~ "Complete", 
      TRUE ~ "Incomplete"
    )
  ) %>%
  group_by(type, subtype_category, complete_subtype) %>%
  summarise(
    total_samples = n(),
    
    # Segment count statistics
    mean_segment_count = round(mean(segment_count, na.rm = TRUE), 1),
    median_segment_count = median(segment_count, na.rm = TRUE),
    min_segment_count = min(segment_count, na.rm = TRUE),
    max_segment_count = max(segment_count, na.rm = TRUE),
    
    # HA presence
    has_ha_count = sum(has_ha == "yes", na.rm = TRUE),
    has_ha_percent = round((has_ha_count / total_samples) * 100, 1),
    
    # HA and NA presence
    has_ha_and_na_count = sum(has_ha_and_na == "yes", na.rm = TRUE),
    has_ha_and_na_percent = round((has_ha_and_na_count / total_samples) * 100, 1),
    
    # Complete genome (8 segments)
    complete_genome_count = sum(segment_count == 8, na.rm = TRUE),
    complete_genome_percent = round((complete_genome_count / total_samples) * 100, 1),
    
    .groups = 'drop'
  ) %>%
  arrange(type, desc(total_samples))

datatable(
  genome_completeness_summary,
  caption = "Genome Completeness Summary by Type and Subtype",
  extensions = 'Buttons',
  options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'print'),
    scrollX = TRUE
  ),
  colnames = c(
    'Type' = 'type',
    'Subtype' = 'subtype_category',
    'Status' = 'complete_subtype',
    'N' = 'total_samples',
    'Mean Seg' = 'mean_segment_count',
    'Med Seg' = 'median_segment_count',
    'Min Seg' = 'min_segment_count',
    'Max Seg' = 'max_segment_count',
    'HA (n)' = 'has_ha_count',
    'HA (%)' = 'has_ha_percent',
    'HA+NA (n)' = 'has_ha_and_na_count',
    'HA+NA (%)' = 'has_ha_and_na_percent',
    'Complete (n)' = 'complete_genome_count',
    'Complete (%)' = 'complete_genome_percent'
  )
) %>%
  formatStyle(columns = c('HA (%)', 'HA+NA (%)', 'Complete (%)'), 
              backgroundColor = styleInterval(c(50, 80), c('lightcoral', 'lightyellow', 'lightgreen'))) %>%
  formatStyle(columns = 'Status',
              backgroundColor = styleEqual(c('Complete', 'Incomplete'), c('lightgreen', 'lightcoral'))) %>%
  formatRound(columns = c('Mean Seg'), digits = 1)
```

## Interactive Table of all frequency data
```{r}
#| column: screen-inset-shaded
datatable(
  data, 
  extensions = 'Buttons', 
  filter = list(position = 'top', clear = FALSE),
  options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'print'),
    scrollX = TRUE # Enables horizontal scrolling
  )
) 
```


# Roadmap 
- Natural language information at the beggining of the report outlining
  - the current date range captured in this report
  - Is influenza a or b dominating 
  - which subtype is dominating 
- Table breakdown of influenza subtype and clade/subclade numbers 
-- Proceed with tables and plots -- 
- Dataset attributes
  - Interactive heatmap of samples with the number of present segments availible. 

## Features 
- Automatic color selection for each clade and subclade within subtypes.


